<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ingreso de Veh√≠culo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7ba1a5">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #000;
      background: #f4f4f4;
    }
    #formularios-container {
      max-width: 950px;
      margin: auto;
      padding: 0;
    }
    .page {
      max-width: 900px;
      margin: 40px auto 40px auto;
      padding: 20px;
      background: #fff;
      page-break-after: always;
    }
    .membrete { text-align: center; }
    .membrete img {
      max-width: 100%;
      height: auto;
    }
    .no-top {
      text-align: right;
      font-size: 12px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    td, th {
      border: 1px solid #000;
      padding: 4px;
      font-size: 12px;
      vertical-align: top;
    }
    input[type="text"], input[type="email"], input[type="number"], select {
      width: 100%;
      border: none;
      font-size: 12px;
      background: transparent;
      outline: none;
    }
    .checkbox-label {
      display: inline-block;
      margin-right: 10px;
    }
    .canvas {
      border: 1px solid black;
      width: 800%;
      max-width: 800px;
      height: 150px;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 14px;
    }
    .td {
      background-color: #7ba1a5;
      text-align: start;
      color: #020202;
    }
    .multi-btns {
      text-align: center;
      margin: 20px 0 10px 0;
    }
    .multi-btns button {
      margin-right: 8px;
    }
    @media print {
      .no-print, .multi-btns { display: none !important; }
      .page { box-shadow: none; border-radius: 0; margin: 0; }
      body { background: #fff; }
    }
  </style>
</head>
<body>
  <div class="multi-btns no-print">
    <button onclick="nuevoFormulario()">‚ûï Nuevo formulario</button>
    <button onclick="imprimirTodos()">üñ®Ô∏è Imprimir TODOS los formularios</button>
  </div>

  <!-- El formulario original AHORA FUERA DEL CONTENEDOR para que nunca desaparezca -->
  <div class="page" id="formulario-original">
    <div class="membrete">
      <img src="membrete Cargus.png" alt="Membrete Cargus">
    </div>
    <div class="no-top">No.: <input type="text" id="numDocumento" style="width: 100px;"></div>
    <table>
      <tr>
        <td class="td">Fecha / Hora:</td>
        <td><input type="text" id="fechaHora" readonly></td>
        <td class="td">Asesor de Servicio:</td>
        <td><input type="text" id="asesor" placeholder="Henry Galindo"></td>
      </tr>
      <tr>
        <td class="td">Nombre del Cliente:</td><td><input type="text" id="cliente"></td>
        <td class="td">Tel√©fono:</td><td><input type="text" id="telefono"></td>
      </tr>
      <tr>
        <td class="td">Email:</td><td colspan="3"><input type="email" id="email"></td>
      </tr>
      <tr>
        <td class="td">Marca:</td><td><input type="text" id="marca"></td>
        <td class="td">Placa:</td><td><input type="text" id="placa"></td>
      </tr>
      <tr>
        <td class="td">TAG:</td><td><input type="text" id="tag"></td>
        <td class="td">No. Veh√≠culo:</td><td><input type="text" id="numeroVehiculo"></td>
      </tr>
      <tr>
        <td class="td">VIN/Chasis:</td><td colspan="3"><input type="text" id="vin"></td>
      </tr>
      <tr>
        <td class="td">Condici√≥n:</td>
        <td colspan="3">
          <label class="checkbox-label"><input type="radio" name="condicion" value="nuevo"> Nuevo</label>
          <label class="checkbox-label"><input type="radio" name="condicion" value="usado"> Usado</label>
        </td>
      </tr>
    </table>
    <table>
      <tr class="td"><th colspan="2">Estado General del Veh√≠culo</th></tr>
      <tr>
        <td><input type="checkbox" id="estadoDeficiente"> Presenta deficiencia en su funcionamiento</td>
        <td><input type="checkbox" id="estadoBueno"> No muestra da√±os, en buenas condiciones</td>
      </tr>
    </table>
    <table>
      <tr class="td"><th colspan="3">Reparaciones o Indicaciones de Carrocer√≠a</th></tr>
      <tr>
        <td><input type="checkbox" id="reparacionRequiere"> Requiere Reparaci√≥n</td>
        <td><input type="checkbox" id="reparacionRevision"> Revisi√≥n para determinar da√±o</td>
        <td><input type="checkbox" id="reparacionBueno"> No muestra da√±os, √≥ptimas condiciones</td>
      </tr>
    </table>
    <table>
      <tr class="td"><th colspan="3">Estado Interno del Veh√≠culo / Consultas al Cliente</th></tr>
      <tr>
        <td colspan="3">
          <label><input type="checkbox" id="internoAsiento"> Asiento</label>
          <label><input type="checkbox" id="internoTimon"> Tim√≥n</label>
          <label><input type="checkbox" id="internoTAG"> TAG</label>
          <label><input type="checkbox" id="internoLuces"> Luces interiores</label>
          <label><input type="checkbox" id="internoDocs"> Documentaci√≥n</label>
          <label><input type="checkbox" id="internoPermiso"> Permiso de explotaci√≥n</label>
          <label><input type="checkbox" id="internoFallas"> Fallas</label>
          <label><input type="checkbox" id="internoOtros"> Otros</label>
        </td>
      </tr>
    </table>
    <table>
      <tr class="td"><th colspan="4">Funcionamiento General</th></tr>
      <tr>
        <td>Kilometraje:<input type="text" id="funcKm"></td>
        <td>Combustible: E <input type="checkbox" id="combE">
            1/4 <input type="checkbox" id="comb14">
            1/2 <input type="checkbox" id="comb12">
            3/4 <input type="checkbox" id="comb34">
            F   <input type="checkbox" id="combF"></td>
        <td><input type="checkbox" id="funcBocinas"> Bocinas</td>
        <td><input type="checkbox" id="funcEmbrague"> Embrague</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="funcFrenoEmerg"> Freno Emergencia</td>
        <td><input type="checkbox" id="funcLuces"> Luces</td>
        <td><input type="checkbox" id="funcAC"> A/C</td>
        <td><input type="checkbox" id="funcParabrisas"> Parabrisas</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="funcPuertas"> Llavines Puertas</td>
        <td><input type="checkbox" id="funcMotor"> Motor</td>
        <td><input type="checkbox" id="funcLimpia"> Limpiaparabrisas</td>
        <td><input type="checkbox" id="funcRociador"> Rociador</td>
      </tr>
    </table>
    <table>
      <tr class="td"><th colspan="4">Accesorios del Veh√≠culo</th></tr>
      <tr>
        <td><input type="checkbox" id="accBateria"> Bater√≠a</td>
        <td><input type="checkbox" id="accBornes"> Borners</td>
        <td><input type="checkbox" id="accProtector"> Protector Bater√≠a</td>
        <td><input type="checkbox" id="accRetrovisores"> Retrovisores</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="accCeniceros"> Ceniceros</td>
        <td><input type="checkbox" id="accEncendedor"> Encendedor</td>
        <td><input type="checkbox" id="accLlantaRepuesto"> Llanta Repuesto</td>
        <td><input type="checkbox" id="accAlfombras"> Alfombras</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="accRadio"> Radio</td>
        <td><input type="checkbox" id="accAntena"> Antena</td>
        <td><input type="checkbox" id="accLoderas"> Loderas</td>
        <td><input type="checkbox" id="accVarillaAceite"> Varilla Aceite</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="accTaponComb"> Tap√≥n Combustible</td>
        <td><input type="checkbox" id="accTaponAceite"> Tap√≥n Aceite</td>
        <td><input type="checkbox" id="accAceiteHidraulico"> Aceite Hidr√°ulico</td>
        <td><input type="checkbox" id="accReservaAgua"> Reserva Agua</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="accAguaParabrisas"> Agua Parabrisas</td>
        <td><input type="checkbox" id="accHerramientas"> Herramientas</td>
        <td colspan="2">Jack <input type="checkbox" id="accJack">
          Llave ruedas <input type="checkbox" id="accLlaveRuedas">
          Maneral <input type="checkbox" id="accManeral">
          Otros: <input type="text" id="accOtros"></td>
      </tr>
    </table>
    <table>
      <tr class="td"><th colspan="2">Seleccione da√±os en la carroceria</th></tr>
      <tr>
        <td><input type="checkbox" id="danioPintura"> Da√±o en la pintura</td>
        <td><input type="checkbox" id="danioCristal"> Da√±o en el cristal</td>
        <td><input type="checkbox" id="danioLuces"> Da√±o en las luces</td>
        <td><input type="checkbox" id="danioFrontal"> Da√±o en pared frontal</td>
      </tr>
      <tr>
        <td><input type="checkbox" id="danioTecho"> Da√±o en el techo</td>
        <td><input type="checkbox" id="danioPuertas"> Da√±o en las puertas</td>
        <td><input type="checkbox" id="danioLaterales"> Da√±o en paredes laterales</td>
        <td><input type="checkbox" id="danioCabina"> Da√±o en la cabina</td>
      </tr>
    </table>
    <div class="firma">
      <p>Indicaciones especiales del cliente:</p>
      <p>a) <input type="text" id="indicacionA" style="width:90%"></p>
      <p>b) <input type="text" id="indicacionB" style="width:90%"></p>
      <p>c) <input type="text" id="indicacionC" style="width:90%"></p>
    </div>
    <table class="table">
      <tr>
        <td>
          <p>Firma del cliente:</p>
          <canvas id="canvasFirma1" width="300" height="120" style="border:1px solid #000"></canvas><br>
          <button class="no-print" type="button" onclick="borrarFirma('canvasFirma1')">Borrar Firma</button>
        </td>
        <td>
          <p>Firma del Asesor:</p>
          <canvas id="canvasFirma2" width="300" height="120" style="border:1px solid #000"></canvas><br>
          <button class="no-print" type="button" onclick="borrarFirma('canvasFirma2')">Borrar Firma</button>
        </td>
      </tr>
    </table>
    <div style="text-align:center;">
      <button class="no-print" onclick="guardarFormulario()">üíæ Guardar en Firebase</button>
      <button class="no-print" onclick="imprimirDesdeApp()">üñ®Ô∏è Imprimir o Guardar como PDF</button>
    </div>
  </div>

  <!-- AQU√ç SOLO LOS FORMULARIOS SINCRONIZADOS, EL ORIGINAL QUEDA FUERA -->
  <div id="formularios-container"></div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBfaasdLIwsBsKy9HlULNMzm-1ec-e83bg",
    authDomain: "ingreso-vehicular---cargus.firebaseapp.com",
    databaseURL: "https://ingreso-vehicular---cargus-default-rtdb.firebaseio.com",
    projectId: "ingreso-vehicular---cargus",
    storageBucket: "ingreso-vehicular---cargus.appspot.com",
    messagingSenderId: "135874840623",
    appId: "1:135874840623:web:17139f071fc0dc9cb35eda"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Funci√≥n para obtener los datos del formulario original
  function getFormularioDataFromDOM(node) {
    const data = {};
    Array.from(node.querySelectorAll('input')).forEach(input => {
      data[input.id] = (input.type === "checkbox" || input.type === "radio") ? input.checked : input.value;
    });
    return data;
  }

  function setFormularioDataToDOM(node, data) {
    Array.from(node.querySelectorAll('input')).forEach(input => {
      if (data[input.id] !== undefined) {
        if (input.type === "checkbox" || input.type === "radio") {
          input.checked = !!data[input.id];
        } else {
          input.value = data[input.id];
        }
      }
    });
  }

  function setFirmaCanvasFromData(canvas, data) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (data) {
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = data;
    }
  }

  function initFirmaCanvasRealtime(canvas, formKey, firmaKey) {
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      } else {
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      }
    }
    function startDrawing(e) {
      isDrawing = true;
      let p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      e.preventDefault();
    }
    function draw(e) {
      if (!isDrawing) return;
      let p = getPos(e);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      e.preventDefault();
    }
    function endDrawing() {
      if (isDrawing) {
        isDrawing = false;
        ctx.beginPath();
        db.ref("multiFormularios/" + formKey + "/firmas/" + firmaKey).set(canvas.toDataURL("image/png"));
      }
    }
    canvas.onmousedown = startDrawing;
    canvas.onmousemove = draw;
    canvas.onmouseup = endDrawing;
    canvas.onmouseout = endDrawing;
    canvas.ontouchstart = startDrawing;
    canvas.ontouchmove = draw;
    canvas.ontouchend = endDrawing;
  }

  function borrarFirmaSync(formKey, firmaKey) {
    const canvas = document.getElementById(firmaKey + "_" + formKey);
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    db.ref("multiFormularios/" + formKey + "/firmas/" + firmaKey).set("");
  }

  function guardarFormularioSync(formKey) {
    const page = document.getElementById("formulario_" + formKey);
    const datos = {};
    Array.from(page.querySelectorAll('input')).forEach(input => {
      datos[input.id.replace("_" + formKey, "")] = (input.type === "checkbox" || input.type === "radio") ? input.checked : input.value;
    });
    db.ref("formularios").push(datos)
      .then(() => alert("‚úÖ Datos guardados en Firebase"))
      .catch((error) => alert("‚ùå Error al guardar: " + error.message));
  }

  function imprimirDesdeApp() {
    window.print();
  }

  function renderAllFormularios(formularios) {
    const container = document.getElementById("formularios-container");
    // Si no hay formularios en Firebase, mostramos el formulario original (plantilla)
    if (!formularios || Object.keys(formularios).length === 0) {
      document.getElementById("formulario-original").style.display = "";
      return;
    }
    container.innerHTML = "";
    Object.entries(formularios).forEach(([key, value], idx) => {
      const orig = document.getElementById("formulario-original");
      const page = orig.cloneNode(true);
      page.id = "formulario_" + key;
      page.style.display = "";
      setFormularioDataToDOM(page, value.datos || {});
      // IDs √∫nicos para canvases
      const canvas1 = page.querySelector("#canvasFirma1");
      const canvas2 = page.querySelector("#canvasFirma2");
      canvas1.id = "canvasFirma1_" + key;
      canvas2.id = "canvasFirma2_" + key;
      setFirmaCanvasFromData(canvas1, value.firmas?.canvasFirma1);
      setFirmaCanvasFromData(canvas2, value.firmas?.canvasFirma2);
      // Botones de firma
      Array.from(page.querySelectorAll('button')).forEach(btn => {
        if (btn.textContent.includes('Borrar Firma')) {
          if (btn.previousElementSibling && btn.previousElementSibling.id.startsWith("canvasFirma1_"))
            btn.setAttribute('onclick', `borrarFirmaSync('${key}','canvasFirma1')`);
          if (btn.previousElementSibling && btn.previousElementSibling.id.startsWith("canvasFirma2_"))
            btn.setAttribute('onclick', `borrarFirmaSync('${key}','canvasFirma2')`);
        }
        if (btn.textContent.includes('Guardar en Firebase')) btn.setAttribute('onclick', `guardarFormularioSync('${key}')`);
        if (btn.textContent.includes('Imprimir o Guardar como PDF')) btn.setAttribute('onclick', 'imprimirDesdeApp()');
      });
      setTimeout(() => {
        initFirmaCanvasRealtime(canvas1, key, "canvasFirma1");
        initFirmaCanvasRealtime(canvas2, key, "canvasFirma2");
        Array.from(page.querySelectorAll('input,select')).forEach(el => {
          el.onchange = function() {
            let nombre = el.id.replace("_" + key, "");
            let val = el.type === "checkbox" ? el.checked : el.value;
            if (el.type === "radio" && !el.checked) return;
            db.ref("multiFormularios/" + key + "/datos/" + nombre).set(val);
          }
        });
      }, 10);
      container.appendChild(page);
    });
    document.getElementById("formulario-original").style.display = "none";
  }

  db.ref("multiFormularios").once("value").then(snap => {
    if (!snap.exists()) {
      const key = Date.now().toString();
      const datos = getFormularioDataFromDOM(document.getElementById("formulario-original"));
      db.ref("multiFormularios/" + key).set({ datos, firmas: { canvasFirma1: "", canvasFirma2: "" } });
    }
    listenMultiFormularios();
  });

  function listenMultiFormularios() {
    db.ref("multiFormularios").on("value", snap => {
      const data = snap.val() || {};
      renderAllFormularios(data);
    });
  }

  function nuevoFormulario() {
    const key = Date.now().toString();
    const datos = getFormularioDataFromDOM(document.getElementById("formulario-original"));
    db.ref("multiFormularios/" + key).set({ datos, firmas: { canvasFirma1: "", canvasFirma2: "" } });
  }

  function imprimirTodos() {
    window.print();
  }

  // El formulario original NUNCA se oculta al cargar, solo se oculta cuando hay formularios sincronizados en firebase
</script>
</body>
</html>
