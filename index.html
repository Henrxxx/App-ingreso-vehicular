<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ingreso de Veh√≠culo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7ba1a5">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #000;
      background: #f4f4f4;
    }
    #formularios-container {
      max-width: 950px;
      margin: auto;
      padding: 0;
    }
    .page {
      max-width: 900px;
      margin: 40px auto 40px auto;
      padding: 20px;
      background: #fff;
      page-break-after: always;
      position: relative;
    }
    .membrete { text-align: center; }
    .membrete img {
      max-width: 100%;
      height: auto;
    }
    .no-top {
      text-align: right;
      font-size: 12px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    td, th {
      border: 1px solid #000;
      padding: 4px;
      font-size: 12px;
      vertical-align: top;
    }
    input[type="text"], input[type="email"], input[type="number"], select {
      width: 100%;
      border: none;
      font-size: 12px;
      background: transparent;
      outline: none;
    }
    .checkbox-label {
      display: inline-block;
      margin-right: 10px;
    }
    .canvas {
      border: 1px solid black;
      width: 800%;
      max-width: 800px;
      height: 150px;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 14px;
    }
    .td {
      background-color: #7ba1a5;
      text-align: start;
      color: #020202;
    }
    .multi-btns {
      text-align: center;
      margin: 20px 0 10px 0;
    }
    .multi-btns button {
      margin-right: 8px;
    }
    .btn-eliminar-formulario {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      background: #ff6666;
      border: none;
      color: #fff;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      padding: 4px 12px;
    }
    @media print {
      .no-print, .multi-btns, .btn-eliminar-formulario { display: none !important; }
      .page { box-shadow: none; border-radius: 0; margin: 0; }
      body { background: #fff; }
    }
  </style>
</head>
<body>
  <div class="multi-btns no-print">
    <button onclick="nuevoFormulario()">‚ûï Nuevo formulario</button>
    <button onclick="imprimirTodos()">üñ®Ô∏è Imprimir TODOS los formularios</button>
  </div>
  <div id="formularios-container">
    <!-- Los formularios se cargar√°n aqu√≠ din√°micamente -->
  </div>
<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBfaasdLIwsBsKy9HlULNMzm-1ec-e83bg",
    authDomain: "ingreso-vehicular---cargus.firebaseapp.com",
    databaseURL: "https://ingreso-vehicular---cargus-default-rtdb.firebaseio.com",
    projectId: "ingreso-vehicular---cargus",
    storageBucket: "ingreso-vehicular---cargus.appspot.com",
    messagingSenderId: "135874840623",
    appId: "1:135874840623:web:17139f071fc0dc9cb35eda"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ----- FORMULARIO BASE -----
  // (El HTML del formulario base, sin id repetidos, se usar√° para clonar nuevos formularios)
  const FORMULARIO_BASE = `
    <div class="page">
      <button class="btn-eliminar-formulario no-print" style="display:none;" type="button">üóëÔ∏è Eliminar</button>
      <div class="membrete">
        <img src="membrete Cargus.png" alt="Membrete Cargus">
      </div>
      <div class="no-top">No.: <input type="text" data-field="numDocumento" style="width: 100px;"></div>
      <table>
        <tr>
          <td class="td">Fecha / Hora:</td>
          <td><input type="text" data-field="fechaHora" readonly></td>
          <td class="td">Asesor de Servicio:</td>
          <td><input type="text" data-field="asesor" placeholder="Henry Galindo"></td>
        </tr>
        <tr>
          <td class="td">Nombre del Cliente:</td><td><input type="text" data-field="cliente"></td>
          <td class="td">Tel√©fono:</td><td><input type="text" data-field="telefono"></td>
        </tr>
        <tr>
          <td class="td">Email:</td><td colspan="3"><input type="email" data-field="email"></td>
        </tr>
        <tr>
          <td class="td">Marca:</td><td><input type="text" data-field="marca"></td>
          <td class="td">Placa:</td><td><input type="text" data-field="placa"></td>
        </tr>
        <tr>
          <td class="td">TAG:</td><td><input type="text" data-field="tag"></td>
          <td class="td">No. Veh√≠culo:</td><td><input type="text" data-field="numeroVehiculo"></td>
        </tr>
        <tr>
          <td class="td">VIN/Chasis:</td><td colspan="3"><input type="text" data-field="vin"></td>
        </tr>
        <tr>
          <td class="td">Condici√≥n:</td>
          <td colspan="3">
            <label class="checkbox-label"><input type="radio" name="condicion" value="nuevo" data-field="condicion"> Nuevo</label>
            <label class="checkbox-label"><input type="radio" name="condicion" value="usado" data-field="condicion"> Usado</label>
          </td>
        </tr>
      </table>
      <table>
        <tr class="td"><th colspan="2">Estado General del Veh√≠culo</th></tr>
        <tr>
          <td><input type="checkbox" data-field="estadoDeficiente"> Presenta deficiencia en su funcionamiento</td>
          <td><input type="checkbox" data-field="estadoBueno"> No muestra da√±os, en buenas condiciones</td>
        </tr>
      </table>
      <table>
        <tr class="td"><th colspan="3">Reparaciones o Indicaciones de Carrocer√≠a</th></tr>
        <tr>
          <td><input type="checkbox" data-field="reparacionRequiere"> Requiere Reparaci√≥n</td>
          <td><input type="checkbox" data-field="reparacionRevision"> Revisi√≥n para determinar da√±o</td>
          <td><input type="checkbox" data-field="reparacionBueno"> No muestra da√±os, √≥ptimas condiciones</td>
        </tr>
      </table>
      <table>
        <tr class="td"><th colspan="3">Estado Interno del Veh√≠culo / Consultas al Cliente</th></tr>
        <tr>
          <td colspan="3">
            <label><input type="checkbox" data-field="internoAsiento"> Asiento</label>
            <label><input type="checkbox" data-field="internoTimon"> Tim√≥n</label>
            <label><input type="checkbox" data-field="internoTAG"> TAG</label>
            <label><input type="checkbox" data-field="internoLuces"> Luces interiores</label>
            <label><input type="checkbox" data-field="internoDocs"> Documentaci√≥n</label>
            <label><input type="checkbox" data-field="internoPermiso"> Permiso de explotaci√≥n</label>
            <label><input type="checkbox" data-field="internoFallas"> Fallas</label>
            <label><input type="checkbox" data-field="internoOtros"> Otros</label>
          </td>
        </tr>
      </table>
      <table>
        <tr class="td"><th colspan="4">Funcionamiento General</th></tr>
        <tr>
          <td>Kilometraje:<input type="text" data-field="funcKm"></td>
          <td>Combustible: E <input type="checkbox" data-field="combE">
              1/4 <input type="checkbox" data-field="comb14">
              1/2 <input type="checkbox" data-field="comb12">
              3/4 <input type="checkbox" data-field="comb34">
              F   <input type="checkbox" data-field="combF"></td>
          <td><input type="checkbox" data-field="funcBocinas"> Bocinas</td>
          <td><input type="checkbox" data-field="funcEmbrague"> Embrague</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="funcFrenoEmerg"> Freno Emergencia</td>
          <td><input type="checkbox" data-field="funcLuces"> Luces</td>
          <td><input type="checkbox" data-field="funcAC"> A/C</td>
          <td><input type="checkbox" data-field="funcParabrisas"> Parabrisas</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="funcPuertas"> Llavines Puertas</td>
          <td><input type="checkbox" data-field="funcMotor"> Motor</td>
          <td><input type="checkbox" data-field="funcLimpia"> Limpiaparabrisas</td>
          <td><input type="checkbox" data-field="funcRociador"> Rociador</td>
        </tr>
      </table>
      <table>
        <tr class="td"><th colspan="4">Accesorios del Veh√≠culo</th></tr>
        <tr>
          <td><input type="checkbox" data-field="accBateria"> Bater√≠a</td>
          <td><input type="checkbox" data-field="accBornes"> Borners</td>
          <td><input type="checkbox" data-field="accProtector"> Protector Bater√≠a</td>
          <td><input type="checkbox" data-field="accRetrovisores"> Retrovisores</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="accCeniceros"> Ceniceros</td>
          <td><input type="checkbox" data-field="accEncendedor"> Encendedor</td>
          <td><input type="checkbox" data-field="accLlantaRepuesto"> Llanta Repuesto</td>
          <td><input type="checkbox" data-field="accAlfombras"> Alfombras</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="accRadio"> Radio</td>
          <td><input type="checkbox" data-field="accAntena"> Antena</td>
          <td><input type="checkbox" data-field="accLoderas"> Loderas</td>
          <td><input type="checkbox" data-field="accVarillaAceite"> Varilla Aceite</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="accTaponComb"> Tap√≥n Combustible</td>
          <td><input type="checkbox" data-field="accTaponAceite"> Tap√≥n Aceite</td>
          <td><input type="checkbox" data-field="accAceiteHidraulico"> Aceite Hidr√°ulico</td>
          <td><input type="checkbox" data-field="accReservaAgua"> Reserva Agua</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="accAguaParabrisas"> Agua Parabrisas</td>
          <td><input type="checkbox" data-field="accHerramientas"> Herramientas</td>
          <td colspan="2">Jack <input type="checkbox" data-field="accJack">
            Llave ruedas <input type="checkbox" data-field="accLlaveRuedas">
            Maneral <input type="checkbox" data-field="accManeral">
            Otros: <input type="text" data-field="accOtros"></td>
        </tr>
      </table>
      <table>
        <tr class="td"><th colspan="2">Seleccione da√±os en la carroceria</th></tr>
        <tr>
          <td><input type="checkbox" data-field="danioPintura"> Da√±o en la pintura</td>
          <td><input type="checkbox" data-field="danioCristal"> Da√±o en el cristal</td>
          <td><input type="checkbox" data-field="danioLuces"> Da√±o en las luces</td>
          <td><input type="checkbox" data-field="danioFrontal"> Da√±o en pared frontal</td>
        </tr>
        <tr>
          <td><input type="checkbox" data-field="danioTecho"> Da√±o en el techo</td>
          <td><input type="checkbox" data-field="danioPuertas"> Da√±o en las puertas</td>
          <td><input type="checkbox" data-field="danioLaterales"> Da√±o en paredes laterales</td>
          <td><input type="checkbox" data-field="danioCabina"> Da√±o en la cabina</td>
        </tr>
      </table>
      <div class="firma">
        <p>Indicaciones especiales del cliente:</p>
        <p>a) <input type="text" data-field="indicacionA" style="width:90%"></p>
        <p>b) <input type="text" data-field="indicacionB" style="width:90%"></p>
        <p>c) <input type="text" data-field="indicacionC" style="width:90%"></p>
      </div>
      <table class="table">
        <tr>
          <td>
            <p>Firma del cliente:</p>
            <canvas class="canvas-firma" width="300" height="120" data-field="firmaCliente" style="border:1px solid #000"></canvas><br>
            <button class="no-print btn-borrar-firma" type="button">Borrar Firma</button>
          </td>
          <td>
            <p>Firma del Asesor:</p>
            <canvas class="canvas-firma" width="300" height="120" data-field="firmaAsesor" style="border:1px solid #000"></canvas><br>
            <button class="no-print btn-borrar-firma" type="button">Borrar Firma</button>
          </td>
        </tr>
      </table>
      <div style="text-align:center;">
        <button class="no-print btn-guardar-firebase" type="button">üíæ Guardar en Firebase</button>
        <button class="no-print btn-imprimir" type="button">üñ®Ô∏è Imprimir o Guardar como PDF</button>
      </div>
    </div>`;

  // ----- UTILIDADES -----
  // Convierte los datos del formulario DOM a un objeto JS
  function formularioADatos(pageDiv) {
    const datos = {};
    pageDiv.querySelectorAll('[data-field]').forEach(input => {
      const key = input.getAttribute('data-field');
      if (input.type === 'checkbox') {
        datos[key] = !!input.checked;
      } else if (input.type === 'radio') {
        if (input.checked) datos[key] = input.value;
      } else if (input.tagName === 'CANVAS') {
        datos[key] = input.toDataURL();
      } else {
        datos[key] = input.value;
      }
    });
    // Firmas (canvas)
    pageDiv.querySelectorAll('.canvas-firma').forEach(canvas => {
      const key = canvas.getAttribute('data-field');
      datos[key] = canvas.toDataURL();
    });
    return datos;
  }
  // Rellena los campos de un formulario DOM desde objeto JS
  function datosAFormulario(pageDiv, datos) {
    pageDiv.querySelectorAll('[data-field]').forEach(input => {
      const key = input.getAttribute('data-field');
      if (typeof datos[key] === 'undefined') return;
      if (input.type === 'checkbox') {
        input.checked = !!datos[key];
      } else if (input.type === 'radio') {
        input.checked = (input.value === datos[key]);
      } else if (input.tagName === 'CANVAS') {
        if (datos[key]) {
          const ctx = input.getContext('2d');
          const img = new Image();
          img.onload = () => ctx.drawImage(img, 0, 0, input.width, input.height);
          img.src = datos[key];
        }
      } else {
        input.value = datos[key];
      }
    });
  }

  // Inicializa canvas de firma
  function initFirmaCanvas(canvas) {
    const ctx = canvas.getContext('2d');
    let isDrawing = false, lastPoint = null;
    canvas.addEventListener('mousedown', e => {
      isDrawing = true;
      lastPoint = { x: e.offsetX, y: e.offsetY };
      ctx.beginPath();
      ctx.moveTo(lastPoint.x, lastPoint.y);
    });
    canvas.addEventListener('mousemove', e => {
      if (!isDrawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });
    canvas.addEventListener('mouseup', () => {
      isDrawing = false;
      ctx.beginPath();
    });
    canvas.addEventListener('mouseout', () => {
      isDrawing = false;
      ctx.beginPath();
    });

    // touch
    canvas.addEventListener('touchstart', e => {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      lastPoint = { x: t.clientX - rect.left, y: t.clientY - rect.top };
      ctx.beginPath();
      ctx.moveTo(lastPoint.x, lastPoint.y);
      e.preventDefault();
    }, { passive: false });
    canvas.addEventListener('touchmove', e => {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
      e.preventDefault();
    }, { passive: false });
    canvas.addEventListener('touchend', () => {
      isDrawing = false;
      ctx.beginPath();
    });
  }

  // ----- CRUD -----
  // Carga todos los formularios desde Firebase
  function cargarFormularios() {
    db.ref('formularios').on('value', snapshot => {
      const cont = document.getElementById('formularios-container');
      cont.innerHTML = '';
      const data = snapshot.val();
      if (!data) return;
      Object.entries(data).forEach(([key, datos]) => {
        const page = htmlToElement(FORMULARIO_BASE);
        page.setAttribute('data-firebase-id', key);
        datosAFormulario(page, datos);
        page.querySelector('.btn-eliminar-formulario').style.display = 'block';
        inicializarEventosFormulario(page, key);
        cont.appendChild(page);
      });
    });
  }

  // A√±ade un nuevo formulario vac√≠o y sincroniza con Firebase al guardar
  function nuevoFormulario() {
    const page = htmlToElement(FORMULARIO_BASE);
    page.querySelector('.btn-eliminar-formulario').style.display = 'block';
    inicializarEventosFormulario(page);
    document.getElementById('formularios-container').appendChild(page);
    setTimeout(() => {
      // Fecha/hora autom√°tica
      const f = page.querySelector('[data-field="fechaHora"]');
      if (f) f.value = new Date().toLocaleString();
    }, 100);
  }

  // Inicializa todos los eventos: firmas, guardar, borrar firma, eliminar, imprimir...
  function inicializarEventosFormulario(page, firebaseId = null) {
    // Firmas
    page.querySelectorAll('.canvas-firma').forEach(initFirmaCanvas);

    // Borrar firmas
    page.querySelectorAll('.btn-borrar-firma').forEach(btn => {
      btn.onclick = function() {
        const canvas = btn.parentNode.querySelector('canvas');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      };
    });

    // Guardar en Firebase
    page.querySelector('.btn-guardar-firebase').onclick = function() {
      const datos = formularioADatos(page);
      if (firebaseId) {
        db.ref('formularios/' + firebaseId).set(datos).then(() => {
          alert("‚úÖ Actualizado en Firebase");
        }).catch(e => alert("‚ùå Error: " + e.message));
      } else {
        const ref = db.ref('formularios').push();
        ref.set(datos).then(() => {
          alert("‚úÖ Guardado en Firebase");
          page.setAttribute('data-firebase-id', ref.key);
        }).catch(e => alert("‚ùå Error: " + e.message));
      }
    };

    // Eliminar formulario
    page.querySelector('.btn-eliminar-formulario').onclick = function() {
      if (firebaseId) {
        if (confirm("¬øEliminar este formulario?")) {
          db.ref('formularios/' + firebaseId).remove();
        }
      } else {
        page.remove();
      }
    };

    // Imprimir/PDF
    page.querySelector('.btn-imprimir').onclick = function() {
      // Solo imprime este formulario
      const originalHtml = document.body.innerHTML;
      document.body.innerHTML = '';
      document.body.appendChild(page.cloneNode(true));
      window.print();
      document.body.innerHTML = originalHtml;
      cargarFormularios();
    };
  }

  // Utilidad: string HTML a elemento DOM
  function htmlToElement(html) {
    const template = document.createElement('template');
    html = html.trim();
    template.innerHTML = html;
    return template.content.firstChild;
  }

  // Imprimir todos los formularios
  function imprimirTodos() {
    window.print();
  }

  // Inicializaci√≥n
  document.addEventListener("DOMContentLoaded", () => {
    cargarFormularios();
  });

  // Exportar funciones a global
  window.nuevoFormulario = nuevoFormulario;
  window.imprimirTodos = imprimirTodos;
</script>
</body>
</html>
